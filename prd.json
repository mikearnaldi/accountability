{
  "project": "Accountability",
  "description": "Multi-company, multi-currency accounting application built on US GAAP principles",
  "version": "3.1.0",
  "created_at": "2026-01-10",
  "updated_at": "2026-01-14",
  "specs_dir": "specs/",
  "available_specs": [
    "ACCOUNTING_RESEARCH.md",
    "EFFECT_BEST_PRACTICES.md",
    "EFFECT_SQL.md",
    "EFFECT_LAYERS.md",
    "EFFECT_TESTING.md",
    "HTTP_API_TANSTACK.md",
    "API_BEST_PRACTICES.md",
    "AUTHENTICATION.md",
    "E2E_TESTING.md",
    "REACT_BEST_PRACTICES.md",
    "USABILITY_BEST_PRACTICES.md"
  ],
  "architecture": {
    "principle": "Effect on server only. Pure React + generated fetch client on frontend.",
    "backend": {
      "packages": [
        "core",
        "persistence",
        "api"
      ],
      "stack": "Effect for type-safe business logic, @effect/sql for database, HttpApi for REST endpoints",
      "testing": "@effect/vitest for unit/integration tests"
    },
    "frontend": {
      "package": "web",
      "stack": "TanStack Start + React + Tailwind CSS + openapi-fetch client",
      "state": "React useState/useReducer for local state. Server state via loaders.",
      "no_effect": "NO Effect code in frontend. Plain fetch via generated openapi-fetch client.",
      "testing": "Playwright for E2E tests"
    },
    "api_client": {
      "generation": "pnpm generate:api in packages/web",
      "tools": "openapi-typescript generates types, openapi-fetch provides typed client",
      "output": [
        "src/api/schema.ts - generated types",
        "src/api/client.ts - configured client"
      ],
      "usage": "import { api } from '@/api/client'; await api.GET('/api/v1/organizations')"
    }
  },
  "technology": {
    "effect": {
      "version": "^3.19.0",
      "scope": "Backend only (core, persistence, api packages)"
    },
    "tanstack_start": {
      "package": "@tanstack/react-start",
      "version": "^1.147.0",
      "patterns": {
        "ssr_data": "Use loader() to fetch data server-side, access via Route.useLoaderData()",
        "ssr_auth": "Use beforeLoad() to check auth from cookie, redirect if needed",
        "client_mutations": "Use api client directly in event handlers, revalidate with router.invalidate()"
      }
    },
    "openapi_fetch": {
      "package": "openapi-fetch",
      "version": "^0.13.0",
      "usage": "Type-safe fetch client generated from OpenAPI spec"
    }
  },
  "testing_policy": {
    "mandatory": "EVERY story MUST include tests. A story is NOT complete without passing tests.",
    "ui_changes": "E2E tests in packages/web/test-e2e/",
    "api_changes": "Unit/integration tests in packages/api/test/ using @effect/vitest.",
    "verification": "Run 'pnpm test && pnpm test:e2e' before marking any story complete."
  },
  "ui_patterns": {
    "data_fetching": {
      "ssr": "loader() fetches data server-side using api client",
      "access": "Route.useLoaderData() in component - data available immediately",
      "mutations": "Call api client in handlers, then router.invalidate() to refetch"
    },
    "auth": {
      "cookie": "httpOnly secure cookie stores session token",
      "ssr_check": "beforeLoad() reads cookie, validates session, redirects if needed",
      "client_check": "Check loader data for user presence"
    },
    "example_route": {
      "code": [
        "export const Route = createFileRoute('/organizations/')({",
        "  beforeLoad: async ({ context }) => {",
        "    // Auth check - redirect if not logged in",
        "    if (!context.user) throw redirect({ to: '/login' })",
        "  },",
        "  loader: async () => {",
        "    // SSR data fetch",
        "    const { data } = await api.GET('/api/v1/organizations')",
        "    return { organizations: data ?? [] }",
        "  },",
        "  component: OrganizationsPage",
        "})",
        "",
        "function OrganizationsPage() {",
        "  const { organizations } = Route.useLoaderData()",
        "  // Data available immediately - no loading state needed for SSR",
        "  return <OrganizationsList items={organizations} />",
        "}"
      ]
    }
  },
  "stories": [
    {
      "id": "11.0.1",
      "phase": "Frontend Rebuild",
      "epic": "Infrastructure",
      "title": "Generate typed API client from OpenAPI spec",
      "description": "Export OpenAPI spec from Effect HttpApi and generate a typed fetch client.",
      "status": "complete",
      "estimated_complexity": "medium"
    },
    {
      "id": "11.0.2",
      "phase": "Frontend Rebuild",
      "epic": "Infrastructure",
      "title": "API: Add httpOnly secure cookie authentication",
      "description": "Update the API auth handlers to set/clear httpOnly secure cookies on login/logout. This enables SSR auth checks.",
      "specs": [
        "AUTHENTICATION.md",
        "API_BEST_PRACTICES.md"
      ],
      "acceptance_criteria": [
        "Login handler sets httpOnly cookie with session token via Set-Cookie header",
        "Logout handler clears the cookie (maxAge=0)",
        "Cookie config: httpOnly=true, secure=true, sameSite=lax, path=/",
        "Cookie name: accountability_session",
        "Existing Bearer token auth continues to work (dual support)",
        "TESTS: Integration test verifies Set-Cookie header on login response"
      ],
      "technical_details": {
        "files_to_modify": [
          "packages/api/src/Layers/AuthApiLive.ts - Add Set-Cookie to login/logout responses"
        ],
        "cookie_config": {
          "name": "accountability_session",
          "httpOnly": true,
          "secure": true,
          "sameSite": "lax",
          "path": "/",
          "maxAge": "30 * 24 * 60 * 60 (30 days)"
        },
        "effect_pattern": "Use HttpServerResponse.setCookie() from @effect/platform"
      },
      "status": "complete",
      "estimated_complexity": "small",
      "priority": "critical"
    },
    {
      "id": "11.0.3",
      "phase": "Frontend Rebuild",
      "epic": "Infrastructure",
      "title": "Root route with SSR auth check",
      "description": "Set up root route to read session cookie and provide user context to all routes.",
      "specs": [
        "REACT_BEST_PRACTICES.md"
      ],
      "acceptance_criteria": [
        "Root route beforeLoad reads session cookie from request",
        "Validates token by calling /api/auth/me endpoint",
        "Returns user object in context for child routes",
        "Child routes access user via Route.useRouteContext()",
        "No flash of unauthenticated content",
        "TESTS (E2E): Authenticated user sees correct UI on page load"
      ],
      "technical_details": {
        "files_to_modify": [
          "packages/web/src/routes/__root.tsx"
        ],
        "pattern": [
          "beforeLoad: async ({ request }) => {",
          "  const cookie = request.headers.get('cookie')",
          "  const token = parseCookie(cookie, 'accountability_session')",
          "  if (!token) return { user: null }",
          "  const { data } = await api.GET('/api/auth/me', {",
          "    headers: { Authorization: `Bearer ${token}` }",
          "  })",
          "  return { user: data?.user ?? null }",
          "}"
        ]
      },
      "status": "complete",
      "estimated_complexity": "medium",
      "depends_on": [
        "11.0.2"
      ]
    },
    {
      "id": "11.1.1",
      "phase": "Frontend Rebuild",
      "epic": "Authentication",
      "title": "Login page with SSR redirect",
      "description": "Build login page using api client. Redirect to home if already authenticated.",
      "specs": [
        "REACT_BEST_PRACTICES.md",
        "USABILITY_BEST_PRACTICES.md"
      ],
      "acceptance_criteria": [
        "beforeLoad redirects to / if user already authenticated",
        "Login form with email/password fields",
        "Submit calls api.POST('/api/auth/login', { body })",
        "On success: cookie is set by API, redirect to / or ?redirect param",
        "On error: display error message",
        "Loading state during submission",
        "TESTS (E2E): Login flow works, sets cookie"
      ],
      "technical_details": {
        "files_to_create": [
          "packages/web/src/routes/login.tsx"
        ],
        "pattern": [
          "beforeLoad: ({ context }) => {",
          "  if (context.user) throw redirect({ to: '/' })",
          "},",
          "component: function LoginPage() {",
          "  const router = useRouter()",
          "  const handleSubmit = async (e) => {",
          "    const { error } = await api.POST('/api/auth/login', { body: formData })",
          "    if (!error) {",
          "      await router.invalidate()",
          "      navigate({ to: '/' })",
          "    }",
          "  }",
          "}"
        ]
      },
      "status": "pending",
      "estimated_complexity": "small",
      "depends_on": [
        "11.0.3"
      ]
    },
    {
      "id": "11.1.2",
      "phase": "Frontend Rebuild",
      "epic": "Authentication",
      "title": "Registration page",
      "description": "Build registration page using api client.",
      "specs": [
        "REACT_BEST_PRACTICES.md",
        "USABILITY_BEST_PRACTICES.md"
      ],
      "acceptance_criteria": [
        "beforeLoad redirects to / if user already authenticated",
        "Registration form with email, displayName, password fields",
        "Client-side validation",
        "Submit calls api.POST('/api/auth/register', { body })",
        "On success: auto-login (cookie set), redirect to /",
        "On error: display validation errors",
        "TESTS (E2E): Registration flow works"
      ],
      "status": "pending",
      "estimated_complexity": "small",
      "depends_on": [
        "11.0.3"
      ]
    },
    {
      "id": "11.2.1",
      "phase": "Frontend Rebuild",
      "epic": "Organizations",
      "title": "Organizations list with SSR",
      "description": "Build organizations list page with server-side data fetching.",
      "specs": [
        "REACT_BEST_PRACTICES.md"
      ],
      "acceptance_criteria": [
        "beforeLoad checks auth, redirects to /login if not authenticated",
        "loader fetches organizations via api.GET('/api/v1/organizations')",
        "Component uses Route.useLoaderData() for immediate data access",
        "No loading spinner on initial page load (SSR)",
        "Create organization: form calls api.POST, then router.invalidate()",
        "Empty state when no organizations",
        "TESTS (E2E): Organizations list renders with data"
      ],
      "technical_details": {
        "files_to_create": [
          "packages/web/src/routes/organizations/index.tsx"
        ]
      },
      "status": "pending",
      "estimated_complexity": "medium",
      "depends_on": [
        "11.1.1"
      ]
    },
    {
      "id": "11.2.2",
      "phase": "Frontend Rebuild",
      "epic": "Organizations",
      "title": "Organization details with SSR",
      "description": "Build organization details page with server-side data fetching.",
      "specs": [
        "REACT_BEST_PRACTICES.md"
      ],
      "acceptance_criteria": [
        "loader fetches organization by ID and its companies",
        "Display organization name, currency, creation date",
        "List companies within the organization",
        "Edit organization: form calls api.PATCH, then router.invalidate()",
        "Link to create new company",
        "TESTS (E2E): Organization details page works"
      ],
      "technical_details": {
        "files_to_create": [
          "packages/web/src/routes/organizations/$organizationId/index.tsx"
        ]
      },
      "status": "pending",
      "estimated_complexity": "medium",
      "depends_on": [
        "11.2.1"
      ]
    },
    {
      "id": "11.3.1",
      "phase": "Frontend Rebuild",
      "epic": "Companies",
      "title": "Companies list with SSR",
      "description": "Build companies list page within an organization.",
      "specs": [
        "REACT_BEST_PRACTICES.md"
      ],
      "acceptance_criteria": [
        "loader fetches companies for organization",
        "Display company cards with name, currency, fiscal year",
        "Create company: form calls api.POST, then router.invalidate()",
        "Link to company details",
        "TESTS (E2E): Companies list works"
      ],
      "status": "pending",
      "estimated_complexity": "medium",
      "depends_on": [
        "11.2.2"
      ]
    },
    {
      "id": "11.3.2",
      "phase": "Frontend Rebuild",
      "epic": "Companies",
      "title": "Company details with SSR",
      "description": "Build company details page with navigation to accounts, journal entries, reports.",
      "specs": [
        "REACT_BEST_PRACTICES.md"
      ],
      "acceptance_criteria": [
        "loader fetches company by ID",
        "Display company info: name, currency, fiscal year, address",
        "Navigation links: Chart of Accounts, Journal Entries, Reports",
        "Edit company: form calls api.PATCH, then router.invalidate()",
        "TESTS (E2E): Company details page works"
      ],
      "status": "pending",
      "estimated_complexity": "medium",
      "depends_on": [
        "11.3.1"
      ]
    },
    {
      "id": "11.4.1",
      "phase": "Frontend Rebuild",
      "epic": "Accounts",
      "title": "Chart of Accounts with SSR",
      "description": "Build chart of accounts page with tree view and CRUD operations.",
      "specs": [
        "REACT_BEST_PRACTICES.md"
      ],
      "acceptance_criteria": [
        "loader fetches accounts for company",
        "Tree view displaying account hierarchy",
        "Filter by account type (Asset, Liability, etc.)",
        "Search by account name/number",
        "Create account: modal form, api.POST, router.invalidate()",
        "Edit account: modal form, api.PATCH, router.invalidate()",
        "TESTS (E2E): Accounts CRUD works"
      ],
      "status": "pending",
      "estimated_complexity": "large",
      "depends_on": [
        "11.3.2"
      ]
    }
  ]
}
